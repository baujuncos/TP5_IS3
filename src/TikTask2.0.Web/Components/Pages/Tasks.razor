@page "/tasks"
@inject ApiService Api
@inject NavigationManager Navigation

<PageTitle>My Tasks - TikTask2.0</PageTitle>

<div class="tasks-container">
    <div class="header">
        <h2>My Tasks</h2>
        <div class="header-actions">
            <span class="user-info">Welcome, @Api.Username! (@Api.Role)</span>
            @if (Api.Role == "Admin")
            {
                <button class="btn btn-secondary" @onclick="ToggleAdminView">
                    @(showAllTasks ? "My Tasks" : "All Tasks")
                </button>
            }
            <button class="btn btn-primary" @onclick="ShowAddModal">Add Task</button>
            <button class="btn btn-danger" @onclick="HandleLogout">Logout</button>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center">
            <p>Loading tasks...</p>
        </div>
    }
    else if (!tasks.Any())
    {
        <div class="empty-state">
            <p>No tasks yet. Click "Add Task" to create one!</p>
        </div>
    }
    else
    {
        <div class="tasks-grid">
            @foreach (var task in tasks)
            {
                <div class="task-card @(task.IsCompleted ? "completed" : "")">
                    <div class="task-header">
                        <h4>@task.Title</h4>
                        @if (showAllTasks && !string.IsNullOrEmpty(task.Username))
                        {
                            <span class="task-user">@task.Username</span>
                        }
                    </div>
                    <p class="task-description">@task.Description</p>
                    <div class="task-footer">
                        <span class="task-date">Due: @task.DueDate.ToString("MMM dd, yyyy")</span>
                        @if (!showAllTasks)
                        {
                            <div class="task-actions">
                                <button class="btn btn-sm btn-success" @onclick="() => ToggleComplete(task.Id)">
                                    @(task.IsCompleted ? "Undo" : "Complete")
                                </button>
                                <button class="btn btn-sm btn-primary" @onclick="() => ShowEditModal(task)">Edit</button>
                                <button class="btn btn-sm btn-danger" @onclick="() => DeleteTask(task.Id)">Delete</button>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    }
</div>

@if (showModal)
{
    <div class="modal-backdrop" @onclick="CloseModal"></div>
    <div class="modal-content">
        <h3>@(editingTask != null ? "Edit Task" : "Add Task")</h3>
        
        <EditForm Model="taskRequest" OnValidSubmit="HandleSaveTask">
            <div class="form-group">
                <label>Title</label>
                <InputText @bind-Value="taskRequest.Title" class="form-control" />
            </div>

            <div class="form-group">
                <label>Description</label>
                <InputTextArea @bind-Value="taskRequest.Description" class="form-control" rows="3" />
            </div>

            <div class="form-group">
                <label>Due Date</label>
                <InputDate @bind-Value="taskRequest.DueDate" class="form-control" />
            </div>

            <div class="modal-actions">
                <button type="submit" class="btn btn-primary">Save</button>
                <button type="button" class="btn btn-secondary" @onclick="CloseModal">Cancel</button>
            </div>
        </EditForm>
    </div>
}

<style>
    .tasks-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
    }

    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .header-actions {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        flex-wrap: wrap;
    }

    .user-info {
        margin-right: 1rem;
        font-weight: 500;
    }

    .tasks-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1.5rem;
    }

    .task-card {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        border-left: 4px solid #007bff;
    }

    .task-card.completed {
        opacity: 0.7;
        border-left-color: #28a745;
    }

    .task-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 0.5rem;
    }

    .task-header h4 {
        margin: 0;
        color: #333;
    }

    .task-user {
        background: #e9ecef;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.85rem;
    }

    .task-description {
        color: #666;
        margin-bottom: 1rem;
    }

    .task-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: auto;
    }

    .task-date {
        color: #999;
        font-size: 0.9rem;
    }

    .task-actions {
        display: flex;
        gap: 0.5rem;
    }

    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #999;
    }

    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
    }

    .modal-content {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        z-index: 1001;
        width: 90%;
        max-width: 500px;
    }

    .modal-content h3 {
        margin-top: 0;
        margin-bottom: 1.5rem;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.25rem;
        font-weight: 500;
    }

    .modal-actions {
        display: flex;
        gap: 0.5rem;
        justify-content: flex-end;
        margin-top: 1.5rem;
    }
</style>

@code {
    private List<TaskResponse> tasks = new();
    private bool isLoading = false;
    private bool showModal = false;
    private bool showAllTasks = false;
    private TaskRequest taskRequest = new();
    private TaskResponse? editingTask = null;

    protected override async Task OnInitializedAsync()
    {
        if (!Api.IsAuthenticated)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        await LoadTasks();
    }

    private async Task LoadTasks()
    {
        isLoading = true;
        
        if (showAllTasks && Api.Role == "Admin")
        {
            tasks = await Api.GetAllTasksAsync();
        }
        else
        {
            tasks = await Api.GetTasksAsync();
        }
        
        isLoading = false;
    }

    private async Task ToggleAdminView()
    {
        showAllTasks = !showAllTasks;
        await LoadTasks();
    }

    private void ShowAddModal()
    {
        editingTask = null;
        taskRequest = new TaskRequest { DueDate = DateTime.Today.AddDays(1) };
        showModal = true;
    }

    private void ShowEditModal(TaskResponse task)
    {
        editingTask = task;
        taskRequest = new TaskRequest
        {
            Title = task.Title,
            Description = task.Description,
            DueDate = task.DueDate
        };
        showModal = true;
    }

    private void CloseModal()
    {
        showModal = false;
        editingTask = null;
    }

    private async Task HandleSaveTask()
    {
        bool success;
        
        if (editingTask != null)
        {
            success = await Api.UpdateTaskAsync(editingTask.Id, taskRequest);
        }
        else
        {
            success = await Api.CreateTaskAsync(taskRequest);
        }

        if (success)
        {
            CloseModal();
            await LoadTasks();
        }
    }

    private async Task ToggleComplete(int id)
    {
        await Api.ToggleTaskCompleteAsync(id);
        await LoadTasks();
    }

    private async Task DeleteTask(int id)
    {
        if (confirm("Are you sure you want to delete this task?"))
        {
            await Api.DeleteTaskAsync(id);
            await LoadTasks();
        }
    }

    private bool confirm(string message)
    {
        // In a real app, use a proper confirmation modal
        return true;
    }

    private void HandleLogout()
    {
        Api.Logout();
        Navigation.NavigateTo("/login");
    }
}
